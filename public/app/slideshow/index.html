<html>
	<head>
	</head>

	<body>
		<p id = 'message'></p>
		<script>
			var autoplay = function() {
				function getScripts(urls, callback) {
					var numDone = 0;
					
					function getScript(url, callback) {
						var script = document.createElement('script'),
								head = document.getElementsByTagName('head')[0],
								done = false;
						
							script.src = url;
							script.onload = script.onreadystatechange = function() {
								if (!done && (!this.readyState || this.readyState == 'loaded' || this.readyState == 'complete')) {
									done = true;
									callback();
									script.onload = script.onreadystatechange = null;
									head.removeChild(script);
								}
							};
						
						head.appendChild(script);
					}
					
					function getScriptCallback() {
						if (urls.length > 0) getScript(urls.shift(), getScriptCallback);
						else callback();
					}
					
					getScript(urls.shift(), getScriptCallback);
				}
				
				getScripts([
					'js/compatibility.js',
					'js/objectdetect.js',
					'js/objectdetect.handopen.js',
					'js/objectdetect.handfist.js',
					'js/jquery.js'],
				
					function() {
						var canvas = $('<canvas style="position: fixed; z-index: 1001;top: 10px; right: 10px; opacity: 0.9">').get(0),
							context = canvas.getContext('2d'),
							video = document.createElement('video'),
							fist_pos_old,
							detector;
						
						document.getElementsByTagName('body')[0].appendChild(canvas);
						
						try {
							compatibility.getUserMedia({video: true}, function(stream) {
								try {
									video.src = compatibility.URL.createObjectURL(stream);
								} catch (error) {
									video.src = stream;
								}
								compatibility.requestAnimationFrame(play);
							}, function (error) {
								alert("WebRTC not available");
							});
						} catch (error) {
							alert(error);
						}
						
						function play() {
							compatibility.requestAnimationFrame(play);
							if (video.paused) video.play();
							
							if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0) {
								
								/* Prepare the detector once the video dimensions are known: */
					          	if (!detector) {
						      		var width = ~~(80 * video.videoWidth / video.videoHeight);
									var height = 80;
						      		detectorHandOpen = new objectdetect.detector(width, height, 1.1, objectdetect.handopen);
						      		detectorHandFist = new objectdetect.detector(width, height, 1.1, objectdetect.handfist);
						      	}
					      	
								/* Draw video overlay: */
								canvas.width = ~~(100 * video.videoWidth / video.videoHeight);
								canvas.height = 100;
								context.drawImage(video, 0, 0, canvas.clientWidth, canvas.clientHeight);
								
								var coordsHandOpen = detectorHandOpen.detect(video, 1);
								if (coordsHandOpen[0]) {
									var coordHandOpen = coordsHandOpen[0];
									
									/* Rescale coordinates from detector to video coordinate space: */
									for (var i = 0; i < coordsHandOpen.length; i++)
										coordHandOpen[i] *= video.videoWidth / detectorHandOpen.canvas.width;
									
									/* Find coordinates with maximum confidence: */
									var coordHandOpen = coordsHandOpen[0];
									for (var i = coordsHandOpen.length - 1; i >= 0; --i)
										if (coordsHandOpen[i][4] > coordHandOpen[4]) coordHandOpen = coordsHandOpen[i];
									
									/* Scroll window: */
									/*var fist_pos = [coord[0] + coord[2] / 2, coord[1] + coord[3] / 2];
									if (fist_pos_old) {
										var dx = (fist_pos[0] - fist_pos_old[0]) / video.videoWidth,
												dy = (fist_pos[1] - fist_pos_old[1]) / video.videoHeight;
										
											window.scrollBy(dx * 200, dy * 200);
									} else fist_pos_old = fist_pos;*/
									
									/* Draw coordinates on video overlay: */
									context.beginPath();
									context.lineWidth = '2';
									context.fillStyle = 'rgba(0, 255, 255, 0.5)';
									context.fillRect(
										coordHandOpen[0] / video.videoWidth * canvas.clientWidth,
										coordHandOpen[1] / video.videoHeight * canvas.clientHeight,
										coordHandOpen[2] / video.videoWidth * canvas.clientWidth,
										coordHandOpen[3] / video.videoHeight * canvas.clientHeight);
									context.stroke();
								} else 
									fist_pos_old = null;

								//start hand fist
								var coordsHandFist = detectorHandFist.detect(video, 1);
								if (coordsHandFist[0]) {
									var coordHandFist = coordsHandFist[0];
									
									/* Rescale coordinates from detector to video coordinate space: */
									for (var i = 0; i < coordsHandFist.length; i++)
										coordHandFist[i] *= video.videoWidth / detectorHandFist.canvas.width;
									
									/* Find coordinates with maximum confidence: */
									var coordHandFist = coordsHandFist[0];
									for (var i = coordsHandFist.length - 1; i >= 0; --i)
										if (coordsHandFist[i][4] > coordHandFist[4]) coordHandFist = coordsHandFist[i];
									
									/* Scroll window: */
									/*var fist_pos = [coord[0] + coord[2] / 2, coord[1] + coord[3] / 2];
									if (fist_pos_old) {
										var dx = (fist_pos[0] - fist_pos_old[0]) / video.videoWidth,
												dy = (fist_pos[1] - fist_pos_old[1]) / video.videoHeight;
										
											window.scrollBy(dx * 200, dy * 200);
									} else fist_pos_old = fist_pos;*/
									
									/* Draw coordinates on video overlay: */
									context.beginPath();
									context.lineWidth = '2';
									context.fillStyle = 'rgba(0, 255, 255, 0.5)';
									context.fillRect(
										coordHandFist[0] / video.videoWidth * canvas.clientWidth,
										coordHandFist[1] / video.videoHeight * canvas.clientHeight,
										coordHandFist[2] / video.videoWidth * canvas.clientWidth,
										coordHandFist[3] / video.videoHeight * canvas.clientHeight);
									context.stroke();
								} else 
									fist_pos_old = null;
								//end hand fist 
							}
						}
					}
				);
			};
			autoplay();
		</script>
	</body>
</html>